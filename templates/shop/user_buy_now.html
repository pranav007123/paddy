{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - Agricultural Intelligence{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-5">
        <div class="col-12">
            <span class="section-tag">Final Step</span>
            <h2 class="section-title"><i class="fas fa-shopping-bag me-2"></i>Complete Your Purchase</h2>
        </div>
    </div>

    <div class="row">
        <!-- Billing & Shipping -->
        <div class="col-lg-8">
            <div class="feature-card p-4 mb-4">
                <h4 class="font-weight-bold mb-4"><i class="fas fa-map-marker-alt text-primary me-2"></i>Delivery
                    Details</h4>
                <form id="checkoutForm">
                    <div class="mb-3">
                        <label for="address" class="form-label text-muted">Full Shipping Address</label>
                        <textarea class="form-control" id="address" name="address"
                            placeholder="Street, Landmark, City, State, ZIP" rows="4"
                            style="border-radius: 12px; border: 1px solid #e2e8f0;"
                            required>{{ current_user.address|default:"" }}</textarea>
                    </div>
                </form>
            </div>

            <div class="feature-card p-4">
                <h4 class="font-weight-bold mb-4"><i class="fas fa-shield-alt text-primary me-2"></i>Secure Payment</h4>
                <div class="alert shadow-sm border-0 d-flex align-items-center"
                    style="background: #eff6ff; border-radius: 12px;">
                    <i class="fas fa-info-circle text-primary me-3 fs-3"></i>
                    <div>
                        <span class="d-block font-weight-bold">Payment via Razorpay</span>
                        <span class="text-muted small">Supports UPI, Cards, and Netbanking. Secured by industry-standard
                            encryption.</span>
                    </div>
                </div>
                <div class="text-center mt-4">
                    <img src="https://help.razorpay.com/house_rules/razorpay_logo.png" alt="Razorpay" height="30"
                        class="opacity-75">
                </div>
            </div>

            <div class="mt-4">
                <a href="{% url 'view_cart' %}" class="btn btn-premium btn-premium-outline"
                    style="color: var(--primary) !important; border-color: var(--primary);">
                    <i class="fas fa-arrow-left"></i> Back to Cart
                </a>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="feature-card p-4 sticky-top" style="top: 100px;">
                <h5 class="font-weight-bold mb-4">Summary</h5>

                <div class="mb-4">
                    {% for item in cart_items %}
                    <div class="d-flex justify-content-between mb-3 small">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-light text-dark me-2">{{ item.quantity }}x</span>
                            <span class="text-secondary">{{ item.plant.name }}</span>
                        </div>
                        <span class="font-weight-bold">₹{{ item.item_total|floatformat:2 }}</span>
                    </div>
                    {% endfor %}
                </div>

                <hr class="mb-4">

                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted small">Subtotal</span>
                    <span class="font-weight-bold small">₹{{ subtotal|floatformat:2 }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted small">Tax (5%)</span>
                    <span class="font-weight-bold small">₹{{ tax|floatformat:2 }}</span>
                </div>
                <div class="d-flex justify-content-between mb-4">
                    <span class="text-muted small">Shipping</span>
                    <span class="font-weight-bold small text-success">₹{{ delivery_charge|floatformat:2 }}</span>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <span class="h5 font-weight-bold mb-0">Total</span>
                    <span class="h3 font-weight-bold text-primary mb-0">₹{{ total_price|floatformat:2 }}</span>
                </div>

                <button id="rzp-button1" class="btn btn-premium btn-premium-primary w-100 py-3">
                    Confirm & Pay <i class="fas fa-arrow-right ms-2"></i>
                </button>

                <div id="payment-message" class="mt-3 text-center text-danger small" style="display:none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Form for Verification -->
<form action="{% url 'verify_payment' %}" method="POST" id="verifyForm">
    {% csrf_token %}
    <input type="hidden" name="razorpay_payment_id" id="razorpay_payment_id">
    <input type="hidden" name="razorpay_order_id" id="razorpay_order_id">
    <input type="hidden" name="razorpay_signature" id="razorpay_signature">
    <input type="hidden" name="address" id="hidden_address">
</form>

<!-- Razorpay Script -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    var options = {
        "key": "{{ razorpay_key_id }}",
        "amount": "{{ payment.amount }}",
        "currency": "INR",
        "name": "Paddy Doctor Shop",
        "description": "Plant Order Payment",
        "image": "/static/images/padlogo2.PNG",
        "order_id": "{{ payment.id }}",
        "handler": function (response) {
            document.getElementById('razorpay_payment_id').value = response.razorpay_payment_id;
            document.getElementById('razorpay_order_id').value = response.razorpay_order_id;
            document.getElementById('razorpay_signature').value = response.razorpay_signature;

            var address = document.getElementById('address').value;
            document.getElementById('hidden_address').value = address;

            document.getElementById('verifyForm').submit();
        },
        "prefill": {
            "name": "{{ current_user.name }}",
            "email": "{{ current_user.email }}",
            "contact": "{{ current_user.phone_number }}"
        },
        "theme": {
            "color": "#059669"
        }
    };

    var rzp1 = new Razorpay(options);

    document.getElementById('rzp-button1').onclick = function (e) {
        var address = document.getElementById('address').value;
        if (!address.trim()) {
            alert("Please enter a shipping address.");
            return;
        }
        rzp1.open();
        e.preventDefault();
    }

    rzp1.on('payment.failed', function (response) {
        alert("Payment Failed: " + response.error.description);
    });
</script>
{% endblock %}